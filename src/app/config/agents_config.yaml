# =============================================================
# src/app/config/agents_config.yaml
# SINGLE SOURCE OF TRUTH for all 12 modules
# =============================================================

global:
  default_score: 70
  red_penalty: 10
  yellow_penalty: 5
  green_bonus: 1
  min_score: 0
  max_score: 100

modules:

  # 1. BORROWINGS MODULE
  borrowings:
    enabled: true
    name: "Borrowings"
    description: "Debt structure, leverage, maturity profile, and borrowing risk analysis"
    agent_prompt: |
      You are a senior credit analyst specializing in debt and leverage analysis.
      Analyze the company's borrowing structure, debt sustainability, maturity profile,
      interest rate risk, and overall leverage risks. Provide insights on refinancing
      risk and debt servicing capacity.
    output_sections: ["Leverage assessment", "Debt structure", "Maturity profile", "Interest rate risk", "Key concerns", "Positives", "Conclusion"]
    input_fields: [short_term_debt, long_term_debt, total_equity, ebitda, ebit, finance_cost, revenue, capex, cwip, total_debt_maturing_lt_1y, total_debt_maturing_1_3y, total_debt_maturing_gt_3y, weighted_avg_interest_rate, floating_rate_debt, fixed_rate_debt, interest_expense, total_debt]
    computed_fields:
      total_debt: ["short_term_debt + long_term_debt + (lease_liabilities or 0)"]
      ebit: ["operating_profit"]
      finance_cost: ["interest"]
      ebitda: ["operating_profit + (depreciation or 0)"]
      revenue: ["revenue or 0"]
    benchmarks:
      de_high: 1.0
      de_moderate: 0.5
      debt_ebitda_high: 4.0
      debt_ebitda_moderate: 2.0
      icr_low: 1.5
      icr_moderate: 3.0
      floating_high: 0.60
      floating_moderate: 0.40
      wacd_high: 0.10
      wacd_moderate: 0.07
      refinancing_high: 0.50
    metrics:
      # Note: generic metrics evaluation does not chain metric-to-metric dependencies.
      # Keep formulas based on input/computed_fields rather than referencing other metrics.
      total_debt: "(short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0)"
      total_assets: "(total_equity or 0) + ((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0))"
      de_ratio: "safe_div(((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0)), (total_equity or 0))"
      debt_ebitda: "safe_div(((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0)), (ebitda or 0))"
      interest_coverage: "safe_div((ebit or 0), (finance_cost or 0))"
      st_debt_share: "safe_div((short_term_debt or 0), ((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0)))"
      # Normalize floating/fixed values: accept either ratios (0-1) or absolute amounts.
      floating_share: "(floating_rate_debt if (0 < floating_rate_debt <= 1) else (safe_div((floating_rate_debt or 0), ((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0))) if floating_rate_debt > 1 else None))"
      fixed_share: "(fixed_rate_debt if (0 < fixed_rate_debt <= 1) else (safe_div((fixed_rate_debt or 0), ((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0))) if fixed_rate_debt > 1 else (max(0, 1 - floating_rate_debt) if (0 < floating_rate_debt <= 1) else None)))"
      wacd: "weighted_avg_interest_rate"
      finance_cost_yield: "safe_div((finance_cost or 0), ((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0)))"
      ocf_to_debt: "safe_div((operating_cash_flow or 0), ((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0)))"
      maturity_lt_1y_pct: "safe_div((total_debt_maturing_lt_1y or 0), ((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0)))"
      maturity_1_3y_pct: "safe_div((total_debt_maturing_1_3y or 0), ((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0)))"
      maturity_gt_3y_pct: "safe_div((total_debt_maturing_gt_3y or 0), ((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0)))"
      maturity_balance: "1 if ((safe_div((total_debt_maturing_1_3y or 0), ((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0))) or 0) >= 0.30 and (safe_div((total_debt_maturing_gt_3y or 0), ((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0))) or 0) >= 0.20) else 0"
      cwip_to_assets: "safe_div((cwip or 0), ((total_equity or 0) + ((short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0))))"
    trends: [debt_cagr, ebitda_cagr, lt_debt_cagr, revenue_cagr, finance_cost_cagr, st_debt_yoy_growth]
    trend_metrics:
      # Which fields to calculate CAGR for
      cagr_fields:
        - total_debt
        - ebitda
        - long_term_debt
        - revenue
        - finance_cost
        - short_term_debt
      # Which fields to track YoY growth for
      yoy_fields:
        - de_ratio
        - debt_ebitda
      # Comparison metrics: metric_name = [field1_cagr - field2_cagr]
      comparison_metrics:
        debt_vs_ebitda_cagr: [total_debt, ebitda]  # positive = debt growing faster (RED in rule A1)
        lt_debt_vs_revenue: [long_term_debt, revenue]  # positive = LT debt growing faster than revenue
        finance_cost_vs_debt: [finance_cost, total_debt]  # positive = finance costs growing faster
    rules:
      # A. Debt Growth & Trend Rules
      - id: A1
        name: "Debt CAGR vs EBITDA CAGR"
        metric: debt_vs_ebitda_cagr
        red: "> 0"
        yellow: "-"
        green: "<= 0"
        insights:
          red:
            summary: "Debt growing faster than earnings capacity"
            implication: "Company is accumulating debt faster than its ability to service it. This trajectory is unsustainable and may lead to credit stress."
            investor_action: "Monitor credit rating outlook, check covenants, assess management's deleveraging plan."
            risk_level: "High"
          green:
            summary: "Healthy debt-to-earnings trajectory"
            implication: "Earnings growth outpacing debt growth indicates improving debt serviceability and financial flexibility."
            investor_action: "Positive signal; company has capacity for strategic investments or shareholder returns."
            risk_level: "Low"
      - id: A3
        name: "LT Debt Up, Revenue Flat"
        metric: lt_debt_vs_revenue
        red: "-"
        yellow: "> 0"
        green: "<= 0"
        insights:
          yellow:
            summary: "Long-term debt growing without revenue growth"
            implication: "Debt is being used for non-revenue generating purposes or expansion hasn't translated to sales yet."
            investor_action: "Investigate use of proceeds - is it for expansion, acquisitions, or refinancing?"
            risk_level: "Medium"
          green:
            summary: "Revenue growth supporting debt levels"
            implication: "Debt is being used productively to grow the business."
            investor_action: "Healthy indicator; monitor execution of growth strategy."
            risk_level: "Low"
      - id: A3b
        name: "Capex Funded by Debt"
        metric: cwip_to_assets
        red: "-"
        yellow: "-"
        green: "> 0.10"
        insights:
          green:
            summary: "Active capital investments underway"
            implication: "Significant CWIP indicates ongoing expansion. Check if funded prudently and expected ROI timeline."
            investor_action: "Review management commentary on project timelines and expected returns."
            risk_level: "Low"
      # B. Leverage Ratios
      - id: B1
        name: "Debt-to-Equity Ratio"
        metric: de_ratio
        red: "> 1.0"
        yellow: "> 0.5"
        green: "<= 0.5"
        insights:
          red:
            summary: "Highly leveraged balance sheet"
            implication: "Debt exceeds equity, indicating significant financial risk. Vulnerable to interest rate shocks and earnings volatility."
            investor_action: "Assess refinancing risk, check for upcoming maturities, review debt covenants."
            risk_level: "High"
            peer_context: "Most investment-grade companies maintain D/E below 1.0x"
          yellow:
            summary: "Moderate leverage levels"
            implication: "Leverage is manageable but warrants monitoring. Limited cushion for unexpected downturns."
            investor_action: "Monitor quarterly for any increase in leverage or deterioration in earnings."
            risk_level: "Medium"
          green:
            summary: "Conservative capital structure"
            implication: "Strong equity base provides cushion against volatility. Company has capacity for strategic borrowing if needed."
            investor_action: "Positive; consider if company is under-leveraged and missing growth opportunities."
            risk_level: "Low"
      - id: B2
        name: "Debt-to-EBITDA"
        metric: debt_ebitda
        red: "> 4.0"
        yellow: "> 2.0"
        green: "<= 2.0"
        insights:
          red:
            summary: "Very high leverage relative to cash generation"
            implication: "Would take 4+ years of EBITDA to repay debt. High refinancing risk and limited financial flexibility."
            investor_action: "Review debt maturity schedule urgently. Check if any covenant breaches are imminent."
            risk_level: "High"
            peer_context: "Rating agencies typically consider >4x as highly speculative"
          yellow:
            summary: "Elevated but manageable leverage"
            implication: "2-4 years of earnings needed to repay debt. May face pressure during economic downturns."
            investor_action: "Monitor EBITDA trends closely. Any earnings decline will worsen this ratio."
            risk_level: "Medium"
          green:
            summary: "Strong debt coverage"
            implication: "Can repay all debt within 2 years of cash generation. Strong position for growth or shareholder returns."
            investor_action: "Favorable credit profile; attractive for lenders and credit upgrade potential."
            risk_level: "Low"
      # C. Interest Coverage Rules
      - id: C1
        name: "Interest Coverage Ratio"
        metric: interest_coverage
        red: "< 1.5"
        yellow: "< 3.0"
        green: ">= 3.0"
        insights:
          red:
            summary: "Critical - earnings barely cover interest"
            implication: "Company is at risk of missing interest payments. Any earnings decline could trigger default."
            investor_action: "HIGH ALERT: Review liquidity position, check for covenant waivers, assess restructuring risk."
            risk_level: "Critical"
            peer_context: "ICR below 1.5x is considered distressed by most credit analysts"
          yellow:
            summary: "Tight interest coverage"
            implication: "Limited margin of safety. Earnings decline of 30-50% could stress debt servicing."
            investor_action: "Monitor earnings stability, check for any refinancing at higher rates."
            risk_level: "Medium"
          green:
            summary: "Comfortable interest coverage"
            implication: "Strong earnings cushion to service debt. Can absorb earnings volatility without stress."
            investor_action: "Healthy indicator; supports credit quality and borrowing capacity."
            risk_level: "Low"
      - id: C2
        name: "Finance Cost vs Debt Growth"
        metric: finance_cost_vs_debt
        red: "-"
        yellow: "> 5.0"
        green: "<= 5.0"
        insights:
          yellow:
            summary: "Interest costs growing faster than debt"
            implication: "Either refinancing at higher rates or floating rate exposure is hurting. Margin compression ahead."
            investor_action: "Check fixed vs floating debt mix. Review recent refinancing terms."
            risk_level: "Medium"
          green:
            summary: "Interest costs under control"
            implication: "Company is managing borrowing costs well. May benefit from favorable refinancing."
            investor_action: "Positive trend; supports margin stability."
            risk_level: "Low"
      # D. Maturity Profile Rules
      - id: D1
        name: "Refinancing Risk"
        metric: maturity_lt_1y_pct
        red: "> 0.50"
        yellow: "> 0.30"
        green: "<= 0.30"
        insights:
          red:
            summary: "High near-term refinancing burden"
            implication: "Over 50% of debt due within 1 year. Significant refinancing risk, especially if credit markets tighten."
            investor_action: "URGENT: Assess liquidity sources, review committed credit lines, check bank relationships."
            risk_level: "High"
          yellow:
            summary: "Moderate refinancing needs"
            implication: "30-50% debt due within a year needs proactive management."
            investor_action: "Monitor refinancing progress and terms. Check available liquidity."
            risk_level: "Medium"
          green:
            summary: "Well-laddered debt maturity"
            implication: "Minimal near-term pressure. Company has time to plan refinancing optimally."
            investor_action: "Favorable maturity profile; reduces execution risk."
            risk_level: "Low"
      - id: D2
        name: "Balanced Maturity"
        metric: maturity_balance
        red: "-"
        yellow: "-"
        green: "> 0"
        insights:
          green:
            summary: "Well-diversified maturity schedule"
            implication: "Debt spread across different tenors reduces bullet payment risk and provides flexibility."
            investor_action: "Positive; indicates proactive treasury management."
            risk_level: "Low"
      # E. Interest Rate Risk
      - id: E1
        name: "Floating Rate Exposure"
        metric: floating_share
        red: "> 0.60"
        yellow: "> 0.40"
        green: "<= 0.40"
        insights:
          red:
            summary: "High sensitivity to interest rate changes"
            implication: "Over 60% floating rate debt means every 1% rate increase significantly impacts finance costs."
            investor_action: "Model P&L impact of rate hikes. Check for hedging instruments."
            risk_level: "High"
          yellow:
            summary: "Moderate interest rate exposure"
            implication: "Balanced but some vulnerability to rate increases."
            investor_action: "Monitor central bank policy and company's hedging strategy."
            risk_level: "Medium"
          green:
            summary: "Well-hedged interest rate position"
            implication: "Predominantly fixed rate debt provides cost predictability."
            investor_action: "Favorable; finance costs are predictable for planning."
            risk_level: "Low"
      # F. Cost of Debt
      - id: F1
        name: "Weighted Avg Cost of Debt"
        metric: wacd
        red: "> 0.10"
        yellow: "> 0.07"
        green: "<= 0.07"
        insights:
          red:
            summary: "High borrowing costs"
            implication: "Above 10% cost of debt suggests either poor credit quality or unfavorable terms. Compresses margins significantly."
            investor_action: "Compare with peers. Check if refinancing opportunities exist at better rates."
            risk_level: "High"
            peer_context: "Investment-grade companies typically borrow at 5-8%"
          yellow:
            summary: "Moderate borrowing costs"
            implication: "7-10% is acceptable for many sectors but limits ROI on leveraged investments."
            investor_action: "Monitor vs peer group. Look for refinancing opportunities."
            risk_level: "Medium"
          green:
            summary: "Favorable borrowing terms"
            implication: "Low cost of debt indicates strong credit profile and/or favorable market timing."
            investor_action: "Competitive advantage; supports returns on capital-intensive projects."
            risk_level: "Low"

  # 2. EQUITY & FUNDING MIX MODULE
  equity_funding_mix:
    enabled: true
    name: "EquityFundingMix"
    description: "Equity quality, retained earnings, dividend policy, and funding mix"
    agent_prompt: |
      You are a senior equity analyst. Evaluate equity quality, retained earnings, 
      dividend sustainability, ROE, funding mix, and dilution risks.
    output_sections: ["Equity quality", "Retained earnings", "Dividend policy", "ROE", "Funding mix", "Concerns", "Positives"]
    input_fields: [share_capital, reserves_and_surplus, net_worth, pat, dividend_paid, free_cash_flow, new_share_issuance, debt_equitymix]
    computed_fields:
      debt: ["short_term_debt + long_term_debt + (lease_liabilities or 0)"]
      share_capital: ["equity_capital or total_equity"]
      reserves_and_surplus: ["reserves or 0"]
      retained_earnings: ["reserves_and_surplus"]
      net_worth: ["share_capital + reserves_and_surplus"]
      pat: ["net_profit"]
      dividends_paid: ["dividends_paid or 0"]
      free_cash_flow: ["cash_from_operating_activity + fixed_assets_purchased"]
      revenue: ["revenue or 0"]
    benchmarks:
      payout_high: 0.50
      roe_good: 0.15
      roe_modest: 0.10
      dilution_high: 0.10
    metrics:
      retained_earnings: "reserves_and_surplus"
      # Alias used by trend engine + summaries
      payout_ratio: "safe_div(abs(dividend_paid), (pat or 0))"
      dividend_payout_ratio: "safe_div(abs(dividend_paid), (pat or 0))"
      dividend_to_fcf: "safe_div(abs(dividend_paid), (free_cash_flow or 0))"

      # Average equity uses previous year's net_worth when available
      avg_equity: "(((net_worth or 0) + (prev.get('net_worth') or (net_worth or 0))) / 2)"
      roe: "safe_div((pat or 0), (((net_worth or 0) + (prev.get('net_worth') or (net_worth or 0))) / 2))"

      # Dilution uses previous year's share_capital (computed_fields produces share_capital per year)
      dilution_pct: "safe_div((new_share_issuance or 0), abs(prev.get('share_capital') or 0))"
      equity_dilution_pct: "safe_div((new_share_issuance or 0), abs(prev.get('share_capital') or 0))"

      # Retained earnings YoY growth (decimal)
      re_growth_yoy: "safe_div(((reserves_and_surplus or 0) - (prev.get('reserves_and_surplus') or 0)), abs(prev.get('reserves_and_surplus') or 0))"
      retained_yoy_pct: "safe_div(((reserves_and_surplus or 0) - (prev.get('reserves_and_surplus') or 0)), abs(prev.get('reserves_and_surplus') or 0))"

      debt_to_equity: "safe_div((debt_equitymix or 0), (net_worth or 0))"
      equity_ratio: "safe_div((net_worth or 0), ((net_worth or 0) + (debt_equitymix or 0)))"
    trends: [retained_earnings_cagr, networth_cagr, pat_cagr, equity_cagr, debt_cagr]
    trend_metrics:
      # Which fields to calculate CAGR for
      cagr_fields:
        - retained_earnings
        - roe
        - payout_ratio
        - pat
        - share_capital
        - debt
      # Which fields to track YoY growth for
      # yoy_fields:
        # - payout_ratio
        # - roe
      # Special trend logic for this module (detected by field names)
      special_trends:
        - dilution_pct  # Track dilution events
        - retained_declining  # Detect 3-year declining trend in retained earnings
        - roe_declining  # Detect 3-year declining trend in ROE
    rules:
      - id: A1
        name: "Retained Earnings Growth"
        metric: re_growth_yoy
        red: "< 0"
        yellow: "< 0.05"
        green: ">= 0.05"
        insights:
          red:
            summary: "Declining retained earnings"
            implication: "Company is consuming more cash than it generates, or paying out more than it earns. Reduces internal funding capacity."
            investor_action: "Check for one-time losses, aggressive dividends, or sustained operating losses. Review sustainability of capital allocation."
            risk_level: "High"
          yellow:
            summary: "Slow retained earnings growth"
            implication: "Internal accrual is positive but modest. May need external funding for major expansions."
            investor_action: "Monitor PAT growth and dividend policy. Assess if payout is too high."
            risk_level: "Medium"
          green:
            summary: "Strong retained earnings accumulation"
            implication: "Company is building equity base through profits. Self-funding capability is improving."
            investor_action: "Positive signal; supports future growth without dilution or debt."
            risk_level: "Low"
      - id: B1
        name: "Return on Equity"
        metric: roe
        red: "< 0.10"
        yellow: "< 0.15"
        green: ">= 0.15"
        insights:
          red:
            summary: "Subpar returns on shareholder capital"
            implication: "Returns below 10% often trail cost of equity. Value destruction risk if sustained."
            investor_action: "Compare with peers and industry average. Check if ROE is depressed by one-time items."
            risk_level: "High"
            peer_context: "Most quality companies maintain ROE above 15%"
          yellow:
            summary: "Moderate but improvable ROE"
            implication: "Acceptable returns but room for improvement through margin expansion or better asset turnover."
            investor_action: "Monitor for improving trends. Check management's ROE improvement initiatives."
            risk_level: "Medium"
          green:
            summary: "Strong shareholder value creation"
            implication: "Returns well above cost of equity. Company is creating value for shareholders."
            investor_action: "Premium valuation justified. Check for consistency across cycles."
            risk_level: "Low"
      - id: C1
        name: "Dividend Payout"
        metric: dividend_payout_ratio
        red: "> 1.0"
        yellow: "> 0.50"
        green: "<= 0.50"
        insights:
          red:
            summary: "Unsustainable dividend - paying more than earned"
            implication: "Payout exceeds 100% of profits. Either dipping into reserves or borrowing for dividends. Not sustainable."
            investor_action: "ALERT: Expect dividend cut ahead. Check if special dividend or one-time occurrence."
            risk_level: "Critical"
          yellow:
            summary: "High but potentially sustainable payout"
            implication: "Paying out 50-100% of profits limits reinvestment capacity. Suitable for mature, stable businesses."
            investor_action: "Assess growth needs. High payout okay if business is mature with limited capex needs."
            risk_level: "Medium"
          green:
            summary: "Balanced dividend with retained growth"
            implication: "Retaining majority of earnings for growth while providing shareholder returns. Healthy balance."
            investor_action: "Favorable; company balancing growth and income. Check dividend growth track record."
            risk_level: "Low"
      - id: D1
        name: "Equity Dilution"
        metric: equity_dilution_pct
        red: "> 0.10"
        yellow: "> 0.05"
        green: "<= 0.05"
        insights:
          red:
            summary: "Significant equity dilution"
            implication: "Share capital increased by >10%. Existing shareholders' ownership significantly reduced. Check valuation at issuance."
            investor_action: "Review reason for issuance - growth funding, deleveraging, or distress? Was it at fair value?"
            risk_level: "High"
          yellow:
            summary: "Moderate dilution"
            implication: "5-10% dilution is notable. Check if EPS growth will offset ownership dilution."
            investor_action: "Verify use of proceeds and expected returns vs dilution cost."
            risk_level: "Medium"
          green:
            summary: "Minimal shareholder dilution"
            implication: "Limited equity issuance preserves existing shareholders' ownership and EPS."
            investor_action: "Positive; company is funding growth without excessive dilution."
            risk_level: "Low"
      - id: E1
        name: "Debt-to-Equity"
        metric: debt_to_equity
        red: "> 1.5"
        yellow: "> 1.0"
        green: "<= 1.0"
        insights:
          red:
            summary: "Debt-heavy capital structure"
            implication: "Debt is 1.5x+ equity. Financial risk is elevated. Vulnerable to interest rate shocks."
            investor_action: "Check interest coverage, assess refinancing risk, review deleveraging plans."
            risk_level: "High"
          yellow:
            summary: "Leveraged but manageable"
            implication: "Equal or slightly higher debt than equity. Watch for deterioration."
            investor_action: "Monitor quarterly. Check if leverage is for growth or covering operating shortfalls."
            risk_level: "Medium"
          green:
            summary: "Equity-dominated capital structure"
            implication: "Strong equity base provides stability. Can access debt markets if needed for growth."
            investor_action: "Favorable; company has financial flexibility for opportunities."
            risk_level: "Low"

  # 3. LIQUIDITY MODULE
  liquidity:
    enabled: true
    name: "Liquidity"
    description: "Short-term liquidity, cash position, and working capital (updated calcs)"
    agent_prompt: |
      You are a liquidity analyst. Evaluate short-term solvency, cash adequacy, and working capital.
    output_sections: ["Liquidity overview", "Cash position", "Working capital", "Concerns", "Assessment"]
    input_fields:
      - year
      - inventories
      - inventory
      - cash_equivalents
      - cash_and_equivalents
      - short_term_debt
      - long_term_debt
      - lease_liabilities
      - other_borrowings
      - preference_capital
      - other_liability_items
      - investments
      - trade_receivables
      - profit_from_operations
      - working_capital_changes
      - direct_taxes
      - expenses
      - depreciation
      - interest_paid_fin

      # computed/normalized fields (filled by computed_fields below)
      - current_assets
      - current_liabilities
      - operating_cash_flow
      - daily_operating_expenses
      - total_debt
      - marketable_securities
      - receivables
      - interest_expense
      - cash_and_equivalents
      - inventory

    computed_fields:
      inventory:
        - "inventory"
        - "inventories"
      cash_and_equivalents:
        - "cash_and_equivalents"
        - "cash_equivalents"
      marketable_securities:
        - "marketable_securities"
        - "investments"
      receivables:
        - "receivables"
        - "trade_receivables"
      current_assets:
        - "current_assets"
        - "(investments or 0) + (inventories or 0) + (trade_receivables or 0)"
      current_liabilities:
        - "current_liabilities"
        - "(short_term_debt or 0) + (other_liability_items or 0)"
      operating_cash_flow:
        - "operating_cash_flow"
        - "(profit_from_operations or 0) + (working_capital_changes or 0) - (direct_taxes or 0)"
        - "cash_from_operating_activity"
      daily_operating_expenses:
        - "daily_operating_expenses"
        - "((expenses or 0) - (depreciation or 0)) / 365"
      total_debt:
        - "total_debt"
        - "(short_term_debt or 0) + (long_term_debt or 0) + (lease_liabilities or 0) + (other_borrowings or 0) + (preference_capital or 0)"
      interest_expense:
        - "interest_expense"
        - "interest_paid_fin"

    benchmarks:
      current_ratio_low: 1.0
      quick_ratio_low: 0.8
      cash_ratio_low: 0.2
    metrics:
      # ---------- Liquidity Ratios ----------
      current_ratio: "safe_div(current_assets, current_liabilities)"
      quick_ratio: "safe_div((current_assets - (inventory or 0)), current_liabilities)"
      cash_ratio: "safe_div((cash_and_equivalents or 0), current_liabilities)"

      # ---------- Defensive Interval Ratio ----------
      defensive_interval_ratio_days: "safe_div(((cash_and_equivalents or 0) + (marketable_securities or 0) + (receivables or 0)), daily_operating_expenses)"

      # ---------- Cash Flow Coverage Ratios ----------
      ocf_to_current_liabilities: "safe_div((operating_cash_flow or 0), current_liabilities)"
      ocf_to_cl: "safe_div((operating_cash_flow or 0), current_liabilities)"
      ocf_to_total_debt: "safe_div((operating_cash_flow or 0), total_debt)"
      interest_coverage_ocf: "safe_div((operating_cash_flow or 0), (interest_expense or 0))"
      cash_coverage_st_debt: "safe_div((cash_and_equivalents or 0), (short_term_debt or 0))"

      # ---------- Core Balances ----------
      cash_and_equivalents: "cash_and_equivalents"
      marketable_securities: "marketable_securities"
      receivables: "receivables"
      inventory: "inventory"
      current_assets: "current_assets"
      current_liabilities: "current_liabilities"
      short_term_debt: "short_term_debt"
      total_debt: "total_debt"
      operating_cash_flow: "operating_cash_flow"
      daily_operating_expenses: "daily_operating_expenses"

    # Detailed per-metric trends (values + YoY + insight)
    # Keys here must match fields present in prepared/enriched historical data.
    detailed_trend_fields:
      cash_and_equivalents: "Cash And Equivalents"
      receivables: "Receivables"
      inventory: "Inventory"
      operating_cash_flow: "Operating Cash Flow"
      current_liabilities: "Current Liabilities"
      current_ratio: "Current Ratio"

    rules:
      - id: L1
        name: "Current Ratio"
        metric: current_ratio
        red: "< 1.0"
        yellow: "< 1.5"
        green: ">= 1.5"
      - id: L2
        name: "Defensive Interval Ratio (Days)"
        metric: defensive_interval_ratio_days
        red: "< 30"
        yellow: "< 90"
        green: ">= 90"


  # 4. QUALITY OF EARNINGS (QoE) MODULE
  quality_of_earnings:
    enabled: true
    name: "Quality of Earnings"
    description: "Cash conversion of earnings, accruals, receivables quality, and earnings sustainability"
    agent_prompt: |
      You are a forensic accounting analyst.
      Evaluate the quality of earnings using cash conversion, accruals, receivables quality, and other income dependence.
    output_sections: ["QoE overview", "Cash conversion", "Accruals", "Receivables quality", "Other income", "Conclusion"]
    input_fields:
      - cash_from_operating_activity
      - net_profit
      - working_capital_changes
      - trade_receivables
      - revenue
      - total_assets
      - other_income
    computed_fields:
      operating_cash_flow: ["cash_from_operating_activity"]
      net_income: ["net_profit"]
      receivables: ["trade_receivables"]
      change_in_working_capital: ["working_capital_changes"]
    metrics:
      operating_cash_flow: "cash_from_operating_activity"
      net_income: "net_profit"
      change_in_working_capital: "working_capital_changes"
      receivables: "trade_receivables"
      revenue: "revenue"
      total_assets: "total_assets"
      other_income: "other_income"
      qoe: "safe_div(cash_from_operating_activity, net_profit)"
      accruals_ratio: "safe_div((net_profit - cash_from_operating_activity), total_assets)"
      revenue_quality: "safe_div(cash_from_operating_activity, revenue)"
      dso: "safe_div(trade_receivables, revenue) * 365"
      wc_adjusted_income: "net_profit - working_capital_changes"
      other_income_ratio: "safe_div(other_income, net_profit)"

    # Detailed trends output (values + YoY + insight)
    detailed_trend_fields:
      qoe: "QoE (CFO/Net Income)"
      accruals_ratio: "Accruals Ratio"
      operating_cash_flow: "Operating Cash Flow"
      net_income: "Net Income"
      revenue_quality: "Revenue Quality (CFO/Revenue)"
      dso: "DSO"
      receivables: "Receivables"
      revenue: "Revenue"
      other_income_ratio: "Other Income Ratio"

    # Add the special nested trend block requested
    detailed_special_trends: [receivables_vs_revenue]

  # 5. ASSET & INTANGIBLE QUALITY MODULE
  asset_intangible_quality:
    enabled: true
    name: "Asset & Intangible Quality"
    description: "Asset turnover, asset age proxy, intangibles intensity, amortization proxy, and CWIP/capex quality signals"
    agent_prompt: |
      You are an analyst focused on asset quality and intangible-heavy balance sheets.
      Evaluate asset turnover, asset age proxy, intangibles build-up, CWIP build-up, and capitalization quality.
    output_sections: ["Asset quality overview", "Turnover", "Asset age", "Intangibles", "CWIP / capitalization", "Conclusion"]
    input_fields:
      - gross_block
      - accumulated_depreciation
      - fixed_assets
      - intangible_assets
      - depreciation
      - total_assets
      - revenue
      - cwip
    computed_fields:
      net_block: ["fixed_assets", "gross_block - accumulated_depreciation"]
    metrics:
      gross_block: "gross_block"
      accumulated_depreciation: "accumulated_depreciation"
      net_block: "net_block"
      revenue: "revenue"
      cwip: "cwip"
      intangible_assets: "intangible_assets"
      total_assets: "total_assets"
      asset_turnover: "safe_div(revenue, net_block)"
      asset_age_proxy: "safe_div(accumulated_depreciation, gross_block)"
      intangible_pct_total_assets: "safe_div(intangible_assets, total_assets)"
      intangible_amortization_proxy: "(depreciation or 0) * (safe_div(intangible_assets, (gross_block + intangible_assets)) or 0)"
      amortization_ratio_proxy: "safe_div(intangible_amortization_proxy, intangible_assets)"

    detailed_trend_fields:
      asset_turnover: "Asset Turnover"
      asset_age_proxy: "Asset Age Proxy"
      intangible_assets: "Intangible Assets"
      intangible_pct_total_assets: "Intangibles % of Total Assets"
      cwip: "CWIP"
      revenue: "Revenue"

    # Special trend blocks to match the provided AIQM trend engine
    detailed_special_trends: [aiqm_capitalization, aiqm_cwip_vs_capitalization]

    # CAGR signals (computed into key_metrics)
    trend_metrics:
      cagr_fields:
        - intangible_assets
        - revenue
        - gross_block
      comparison_metrics:
        intangible_cagr_vs_revenue_cagr: [intangible_assets, revenue]

  # 6. CAPEX & CWIP MODULE
  capex_cwip:
    enabled: true
    name: "Capex & CWIP"
    description: "Capex intensity, CWIP build-up, asset turnover on NFA, debt-funded capex, and FCF coverage"
    agent_prompt: |
      You are an analyst focused on capital allocation and reinvestment cycles.
      Evaluate capex intensity, CWIP build-up, asset turnover on net fixed assets, and whether capex is debt-funded.
    output_sections: ["Capex overview", "CWIP", "Capex intensity", "Funding mix", "Conclusion"]
    input_fields:
      - gross_block
      - accumulated_depreciation
      - net_fixed_assets
      - fixed_assets_purchased
      - profit_from_operations
      - working_capital_changes
      - interest_paid_fin
      - direct_taxes
      - operating_cash_flow
      - free_cash_flow
      - cwip
      - revenue
      - short_term_debt
      - long_term_debt
      - lease_liabilities
    computed_fields:
      net_fixed_assets:
        - "net_fixed_assets or (gross_block - accumulated_depreciation)"
      capex:
        - "capex or fixed_assets_purchased"
      operating_cash_flow:
        - "operating_cash_flow or (profit_from_operations + working_capital_changes + interest_paid_fin - direct_taxes)"
      free_cash_flow:
        - "free_cash_flow or (operating_cash_flow - capex)"
    metrics:
      capex: "capex"
      cwip: "cwip"
      nfa: "net_fixed_assets"
      revenue: "revenue"
      operating_cash_flow: "operating_cash_flow"
      free_cash_flow: "free_cash_flow"
      capex_intensity: "safe_div(capex, revenue)"
      cwip_pct: "safe_div(cwip, net_fixed_assets)"
      asset_turnover: "safe_div(revenue, net_fixed_assets)"
      debt_funded_capex: "safe_div((short_term_debt + long_term_debt) - ((prev.get('short_term_debt') or 0) + (prev.get('long_term_debt') or 0)), capex)"
      fcf_coverage: "safe_div(free_cash_flow, capex)"

    detailed_trend_fields:
      cwip: "CWIP"
      capex: "Capex"
      nfa: "Net Fixed Assets (NFA)"
      revenue: "Revenue"
      capex_intensity: "Capex Intensity (Capex/Revenue)"
      cwip_pct: "CWIP % of NFA"
      asset_turnover: "Asset Turnover (Revenue/NFA)"
      debt_funded_capex: "Debt-Funded Capex (Î”Debt/Capex)"
      fcf_coverage: "FCF Coverage (FCF/Capex)"

    trend_metrics:
      cagr_fields:
        - cwip
        - capex
        - nfa
        - revenue
      yoy_fields:
        - cwip
        - capex
        - nfa
        - revenue
      special_trends:
        - cwip_increasing_3y
        - capex_increasing_3y
        - nfa_increasing_3y

  # 7. WORKING CAPITAL MODULE
  working_capital:
    enabled: true
    name: "Working Capital"
    description: "DSO/DIO/DPO, cash conversion cycle, net working capital, and working capital intensity"
    agent_prompt: |
      You are a working capital analyst.
      Evaluate receivables, inventory, payables efficiency and the cash conversion cycle.
    output_sections: ["Working capital overview", "Receivables", "Inventory", "Payables", "Cash conversion", "Conclusion"]
    input_fields:
      - trade_receivables
      - inventories
      - trade_payables
      - revenue
      - cogs
      - manufacturing_cost
      - material_cost
      - operating_profit
    computed_fields:
      inventory:
        - "inventory"
        - "inventories"
      cogs:
        - "cogs"
        - "revenue * ((manufacturing_cost or 0) + (material_cost or 0)) / 100"
        - "(revenue or 0) - (operating_profit or 0)"
    metrics:
      trade_receivables: "trade_receivables"
      inventory: "inventory"
      trade_payables: "trade_payables"
      revenue: "revenue"
      cogs: "cogs"
      dso: "safe_div(trade_receivables, revenue) * 365"
      dio: "safe_div(inventory, cogs) * 365"
      dpo: "safe_div(trade_payables, cogs) * 365"
      ccc: "(safe_div(trade_receivables, revenue) * 365) + (safe_div(inventory, cogs) * 365) - (safe_div(trade_payables, cogs) * 365)"
      cash_conversion_cycle: "(safe_div(trade_receivables, revenue) * 365) + (safe_div(inventory, cogs) * 365) - (safe_div(trade_payables, cogs) * 365)"
      nwc: "(trade_receivables or 0) + (inventory or 0) - (trade_payables or 0)"
      nwc_ratio: "safe_div(((trade_receivables or 0) + (inventory or 0) - (trade_payables or 0)), revenue)"

    detailed_trend_fields:
      trade_receivables: "Trade Receivables"
      inventory: "Inventory"
      trade_payables: "Trade Payables"
      revenue: "Revenue"
      dso: "DSO"
      dio: "DIO"
      dpo: "DPO"
      ccc: "Cash Conversion Cycle"
      nwc: "Net Working Capital"
      nwc_ratio: "NWC / Revenue"

  # 8. RISK SCENARIO DETECTION MODULE
  risk_scenario_detection:
    enabled: true
    name: "Risk Scenario Detection"
    description: "Detects forensic risk scenarios such as zombie company behavior, window dressing, asset stripping, loan evergreening, and circular trading"
    agent_prompt: |
      You are a forensic risk analyst.
      Detect risk scenarios across profitability, cashflows, leverage and working capital movements.
    output_sections: ["Zombie company", "Window dressing", "Asset stripping", "Loan evergreening", "Circular trading"]
    input_fields:
      - year
      - revenue
      - operating_profit
      - interest
      - net_profit
      - other_income
      - depreciation
      - borrowings
      - short_term_debt
      - long_term_debt
      - lease_liabilities
      - fixed_assets
      - total_assets
      - trade_receivables
      - cash_equivalents
      - cash_from_operating_activity
      - dividends_paid
      - proceeds_from_borrowings
      - repayment_of_borrowings
      - interest_paid_fin
      - related_party_sales
      - related_party_receivables

    computed_fields:
      ebitda:
        - "operating_profit + (depreciation or 0)"
      cash:
        - "cash_equivalents or cash_and_equivalents"
      total_borrowings:
        - "borrowings"
        - "(short_term_debt + long_term_debt + (lease_liabilities or 0))"
      net_debt:
        - "(total_borrowings or 0) - (cash or 0)"
      cfo:
        - "cash_from_operating_activity"
      receivables:
        - "trade_receivables"

    metrics:
      revenue: "revenue"
      ebit: "operating_profit"
      interest: "interest"
      net_profit: "net_profit"
      other_income: "other_income"
      depreciation: "depreciation"
      ebitda: "ebitda"
      cfo: "cash_from_operating_activity"
      cash: "cash"
      fixed_assets: "fixed_assets"
      receivables: "trade_receivables"
      net_debt: "net_debt"

    # Explicitly disable default per-metric detailed trends for this module
    detailed_trend_fields: {}
    detailed_special_trends: [risk_scenarios]

  # 9. LEVERAGE & FINANCIAL RISK MODULE
  leverage_financial_risk:
    enabled: true
    name: "Leverage & Financial Risk"
    description: "Leverage ratios + Fitch/S&P-style FFO coverage and debt service burden trends"
    agent_prompt: |
      You are a senior credit analyst.
      Analyze leverage and financial risk using debt, EBITDA, interest, tax and FFO-style cash flow coverage.
    output_sections: ["Overview", "Basic leverage", "FFO coverage", "Debt service burden", "Conclusion"]

    input_fields:
      - year
      - borrowings
      - short_term_debt
      - long_term_debt
      - lease_liabilities
      - cash_equivalents
      - cash_and_equivalents
      - total_equity
      - equity
      - operating_profit
      - ebit
      - depreciation
      - interest
      - finance_cost
      - profit_before_tax
      - tax

    metrics:
      # Absolute values (canonical keys)
      total_debt: "round((borrowings or (short_term_debt + long_term_debt + (lease_liabilities or 0))) or 0, 2)"
      short_term_debt: "round((short_term_debt or 0), 2)"
      cash: "round((cash_equivalents or cash_and_equivalents or 0), 2)"
      equity: "round((total_equity or equity or 0), 2)"
      ebit: "round((operating_profit or ebit or 0), 2)"
      ebitda: "round(((operating_profit or ebit or 0) + (depreciation or 0)), 2)"
      interest_cost: "round((interest or finance_cost or 0), 2)"
      taxes: "round(((profit_before_tax or 0) * parse_tax_rate(tax)), 2)"
      net_debt: "round((((borrowings or (short_term_debt + long_term_debt + (lease_liabilities or 0))) or 0) - (cash_equivalents or cash_and_equivalents or 0)), 2)"
      ffo: "round(((((operating_profit or ebit or 0) + (depreciation or 0)) - (interest or finance_cost or 0) - (((profit_before_tax or 0) * parse_tax_rate(tax))))), 2)"

      # Ratios (canonical keys)
      de_ratio: "round(safe_div(((borrowings or (short_term_debt + long_term_debt + (lease_liabilities or 0))) or 0), (total_equity or equity or 0)) or 0, 6)"
      debt_ebitda: "round(safe_div(((borrowings or (short_term_debt + long_term_debt + (lease_liabilities or 0))) or 0), ((operating_profit or ebit or 0) + (depreciation or 0))) or 0, 6)"
      net_debt_ebitda: "round(safe_div((((borrowings or (short_term_debt + long_term_debt + (lease_liabilities or 0))) or 0) - (cash_equivalents or cash_and_equivalents or 0)), ((operating_profit or ebit or 0) + (depreciation or 0))) or 0, 6)"
      interest_coverage: "round(safe_div((operating_profit or ebit or 0), (interest or finance_cost or 0)) or 0, 6)"
      st_debt_ratio: "round(safe_div((short_term_debt or 0), ((borrowings or (short_term_debt + long_term_debt + (lease_liabilities or 0))) or 0)) or 0, 6)"
      ffo_coverage: "round(safe_div(((((operating_profit or ebit or 0) + (depreciation or 0)) - (interest or finance_cost or 0) - (((profit_before_tax or 0) * parse_tax_rate(tax))))), (interest or finance_cost or 0)) or 0, 6)"

    # Explicitly disable default per-metric detailed trends for this module.
    # It uses a special nested trends block to match the reference structure.
    detailed_trend_fields: {}
    detailed_special_trends: [leverage_financial_risk]

